# Plan: Enhanced Draw Matchup Announcements

## Task Description
Модифікувати команду `/draw` так, щоб замість одного повідомлення з усіма парами бійців, кожен бій анонсувався окремим повідомленням з:
1. Інтригуючим AI-згенерованим інтро на основі опису кожного бійця
2. Колажем, де один півень протистоїть іншому (використовуючи існуючі presentation.png зображення)
3. Видаленням згадок про "прес-конференцію" з цього флоу

## Objective
Після виконання плану команда `/draw` буде відправляти 3 окремих повідомлення (по одному на кожен бій), кожне з яких містить:
- Драматичне інтро, згенероване AI на основі описів обох бійців
- Колаж-зображення "VS" де два бійці протистоять один одному
- Інформацію про номер бою

## Problem Statement
Поточна реалізація `/draw` надсилає одне текстове повідомлення зі списком усіх пар. Це недостатньо захоплююче та не використовує наявні презентаційні зображення бійців. Потрібно створити більш імерсивний досвід з окремими анонсами кожного бою.

## Solution Approach
1. Створити нову функцію для генерації колажу "VS" з двох presentation.png зображень (PIL/Pillow)
2. Створити новий промпт для Claude API, який генерує інтригуючі інтро для кожного бою
3. Модифікувати `draw_command` для відправки окремих повідомлень з фото + caption
4. Оновити текстові константи, видаливши згадки про прес-конференцію

## Relevant Files
Використовуй ці файли для виконання завдання:

- `src/bot.py` - Головний файл бота, містить `draw_command` який потрібно модифікувати
- `src/prompts.py` - Містить текстові шаблони та промпти; потрібно додати новий промпт для інтро
- `src/image_generator.py` - Генерація зображень через Gemini; потрібно додати функцію створення колажу
- `src/state_manager.py` - Містить клас `Fighter` з описами бійців (тільки для читання)
- `data/images/*/presentation.png` - Існуючі презентаційні зображення всіх 6 бійців

### New Files
- Новий файл `src/collage_generator.py` - Функція для створення VS-колажу з двох зображень

## Implementation Phases

### Phase 1: Foundation
- Встановити Pillow для роботи з зображеннями
- Створити функцію генерації VS-колажу
- Створити промпт для генерації інтро до бою

### Phase 2: Core Implementation
- Модифікувати `draw_command` для відправки окремих повідомлень
- Інтегрувати генерацію інтро через Claude API
- Інтегрувати створення VS-колажу

### Phase 3: Integration & Polish
- Видалити згадки про прес-конференцію з draw flow
- Оновити текстові константи
- Протестувати повний флоу

## Step by Step Tasks
IMPORTANT: Execute every step in order, top to bottom.

### 1. Встановити Pillow
- Додати `pillow` до залежностей через `uv add pillow`
- Це потрібно для створення VS-колажів з двох зображень

### 2. Створити модуль collage_generator.py
- Створити новий файл `src/collage_generator.py`
- Реалізувати функцію `create_vs_collage(image1_path: str, image2_path: str) -> bytes`
- Логіка:
  - Завантажити обидва presentation.png зображення
  - Створити канву з текстом "VS" посередині
  - Розмістити бійця 1 зліва, бійця 2 справа
  - Додати драматичний ефект (градієнт, тіні)
  - Повернути як bytes (PNG)

### 3. Створити промпт для генерації інтро
- У `src/prompts.py` додати константу `FIGHT_INTRO_SYSTEM_PROMPT`
- Додати функцію `get_fight_intro_prompt(fighter1_name, fighter1_desc, fighter2_name, fighter2_desc, fight_number)`
- Промпт має генерувати 2-3 речення драматичного інтро українською
- Стиль: як анонсер UFC/боксу, інтригуюче, хайпове

### 4. Створити функцію генерації інтро
- У `src/text_generator.py` додати функцію `generate_fight_intro(...)`
- Використовувати Claude API аналогічно до `generate_trash_talk`
- Повертати згенероване інтро як string

### 5. Модифікувати draw_command
- У `src/bot.py` змінити `draw_command`:
  - Замість одного повідомлення `get_draw_announcement()`
  - Для кожної пари:
    1. Згенерувати інтро через `generate_fight_intro()`
    2. Створити VS-колаж через `create_vs_collage()`
    3. Відправити фото з caption (інтро + "БІЙ X: Name1 vs Name2")
    4. Додати затримку між повідомленнями (1-2 сек)
  - В кінці - коротке повідомлення про готовність до /conference

### 6. Оновити текстові константи
- У `src/prompts.py`:
  - Оновити `DRAW_ANNOUNCEMENT_OUTRO` - видалити згадку про прес-конференцію
  - Оновити `HELP_TEXT` якщо потрібно
  - Видалити або спростити `DRAW_ANNOUNCEMENT_INTRO` та `DRAW_PAIR_TEMPLATE` (більше не потрібні)

### 7. Оновити імпорти в bot.py
- Додати імпорт `create_vs_collage` з `collage_generator`
- Додати імпорт `generate_fight_intro` з `text_generator`

### 8. Протестувати реалізацію
- Запустити бота через `uv run python -m src.bot`
- Викликати `/draw` і перевірити:
  - 3 окремих повідомлення з фото
  - Кожне фото - VS-колаж двох бійців
  - Кожен caption містить AI-згенероване інтро
  - Немає згадок про прес-конференцію

## Testing Strategy
1. **Unit тести**: Тестувати `create_vs_collage` з mock-зображеннями
2. **Інтеграційні тести**: Перевірити генерацію інтро через Claude API
3. **E2E тест**: Повний флоу `/draw` в Telegram

## Acceptance Criteria
- [ ] Команда `/draw` відправляє 3 окремих повідомлення замість одного
- [ ] Кожне повідомлення містить VS-колаж з двох presentation.png зображень
- [ ] Кожне повідомлення містить AI-згенероване інтригуюче інтро
- [ ] Видалено згадки про "прес-конференцію" з draw flow
- [ ] Повідомлення відправляються з невеликою затримкою (1-2 сек) для драматичного ефекту
- [ ] Колаж має текст "VS" посередині та імена бійців
- [ ] Код компілюється без помилок

## Validation Commands
Execute these commands to validate the task is complete:

- `uv run python -m py_compile src/bot.py src/prompts.py src/collage_generator.py src/text_generator.py` - Перевірити синтаксис
- `uv run python -c "from src.collage_generator import create_vs_collage; print('OK')"` - Перевірити імпорт колаж-генератора
- `uv run python -c "from src.text_generator import generate_fight_intro; print('OK')"` - Перевірити імпорт функції інтро

## Notes
- Потрібно встановити Pillow: `uv add pillow`
- Колаж створюється локально через Pillow (не через Gemini) для швидкості та надійності
- Інтро генерується через Claude API (вже налаштований в проекті)
- Затримки між повідомленнями потрібні для rate limiting Telegram API
- Презентаційні зображення вже існують для всіх 6 бійців
